#!/usr/bin/env bash

# ==============================================================================
#                         07 - é…ç½® Rime (é¼ é¡»ç®¡) è¾“å…¥æ³•
# ==============================================================================
#
# åŠŸèƒ½: å®‰è£…é¼ é¡»ç®¡è¾“å…¥æ³• (Squirrel) å¹¶å…‹éš† rime-ice é…ç½®æ–‡ä»¶ã€‚
# ä¾èµ–: Homebrew, git
#
# ==============================================================================

# å¼•å…¥å…±äº«è¾…åŠ©å‡½æ•°
source "$(dirname "$0")/_helpers.sh"

# å®‰è£…å’Œé…ç½® Rime è¾“å…¥æ³•
setup_rime() {
    info "å¼€å§‹é…ç½® Rime è¾“å…¥æ³•..."
    # å®‰è£…é¼ é¡»ç®¡ App
    install_package "squirrel" "--cask"

    local target_dir="$HOME/Library/Rime"
    local repo_url="https://github.com/iDvel/rime-ice.git"
    
    if [ -d "$target_dir" ]; then
        warn "æ£€æµ‹åˆ° Rime ç›®å½•å·²å­˜åœ¨ ($target_dir)ã€‚"
        info "å°†ä¸ä¼šè‡ªåŠ¨å…‹éš† rime-ice é…ç½®ï¼Œä»¥é˜²è¦†ç›–æ‚¨çš„ç°æœ‰è®¾ç½®ã€‚"
        info "å¦‚éœ€æ›´æ–°ï¼Œè¯·è¿›å…¥è¯¥ç›®å½•æ‰‹åŠ¨æ‰§è¡Œ 'git pull' æˆ–å…¶ä»–æ“ä½œã€‚"
    else
        if ! command_exists git; then
            error "'git' å‘½ä»¤æœªæ‰¾åˆ°ã€‚è¯·å…ˆè¿è¡Œå‘½ä»¤è¡Œå·¥å…·å®‰è£…è„šæœ¬ (02_install_cli_tools.sh)ã€‚"
        fi
        info "æ­£åœ¨å…‹éš† rime-ice é…ç½®åˆ° $target_dir..."
        if git clone "$repo_url" "$target_dir" --depth 1; then
            success "Rime é…ç½®å…‹éš†æˆåŠŸã€‚"
            info "è¯·æ³¨é”€å¹¶é‡æ–°ç™»å½•ç³»ç»Ÿï¼Œç„¶ååœ¨è¾“å…¥æ³•è®¾ç½®ä¸­æ·»åŠ â€œé¼ é¡»ç®¡â€ï¼Œæœ€åç‚¹å‡»èœå•æ çš„å›¾æ ‡é€‰æ‹©â€œé‡æ–°éƒ¨ç½²â€ä»¥åº”ç”¨é…ç½®ã€‚"
        else
            warn "å…‹éš† rime-ice å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– Gitã€‚"
        fi
    fi
}

# --- ä¸»å‡½æ•° ---
main() {
    info "--- å¼€å§‹æ‰§è¡Œ Rime è¾“å…¥æ³•é…ç½®è„šæœ¬ ---"
    check_brew_installed
    setup_rime

    echo
    success "============================================================"
    success "           Rime è¾“å…¥æ³•é…ç½®è„šæœ¬æ‰§è¡Œå®Œæ¯•! ğŸ‰"
    success "============================================================"
    echo
}

# --- è„šæœ¬å…¥å£ ---
main
